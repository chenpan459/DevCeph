# RBD (RADOS Block Device) ä»£ç è¯¦è§£

## ğŸ“‹ ç›®å½•
1. [RBD æ•´ä½“æ¶æ„](#ä¸€rbd-æ•´ä½“æ¶æ„)
2. [ä»£ç ç›®å½•ç»“æ„](#äºŒä»£ç ç›®å½•ç»“æ„)
3. [æ ¸å¿ƒæ•°æ®ç»“æ„](#ä¸‰æ ¸å¿ƒæ•°æ®ç»“æ„)
4. [I/O æ•°æ®è·¯å¾„](#å››io-æ•°æ®è·¯å¾„)
5. [å¿«ç…§ä¸å…‹éš†](#äº”å¿«ç…§ä¸å…‹éš†)
6. [ç¼“å­˜æœºåˆ¶](#å…­ç¼“å­˜æœºåˆ¶)
7. [é•œåƒä¸å¤åˆ¶](#ä¸ƒé•œåƒä¸å¤åˆ¶)
8. [æ€§èƒ½ä¼˜åŒ–](#å…«æ€§èƒ½ä¼˜åŒ–)

---

## ä¸€ã€RBD æ•´ä½“æ¶æ„

### 1.1 RBD åœ¨ Ceph ä¸­çš„ä½ç½®

```
åº”ç”¨å±‚ï¼šè™šæ‹Ÿæœº/å®¹å™¨
        â”‚
        â–¼
    /dev/rbd0 (å—è®¾å¤‡)
        â”‚
        â”œâ”€ å†…æ ¸æ¨¡å— (krbd)
        â”‚  â””â”€ drivers/block/rbd.c
        â”‚
        â””â”€ ç”¨æˆ·æ€åº“ (librbd)
           â””â”€ src/librbd/
        â”‚
        â–¼
    librados (RADOS å®¢æˆ·ç«¯)
        â”‚
        â–¼
    RADOS (OSD é›†ç¾¤)
```

### 1.2 RBD æ ¸å¿ƒæ¦‚å¿µ

#### å¯¹è±¡æ˜ å°„

```
RBD Image (å—è®¾å¤‡)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è™šæ‹Ÿå—è®¾å¤‡ï¼š10 GB                                   â”‚
â”‚  æ¡å¸¦å¤§å°ï¼š4 MB (é»˜è®¤)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ æ˜ å°„åˆ°
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RADOS å¯¹è±¡                                          â”‚
â”‚                                                      â”‚
â”‚  rbd_data.<image_id>.0000000000000000  (4MB)        â”‚
â”‚  rbd_data.<image_id>.0000000000000001  (4MB)        â”‚
â”‚  rbd_data.<image_id>.0000000000000002  (4MB)        â”‚
â”‚  ...                                                 â”‚
â”‚  rbd_data.<image_id>.0000000000000a3f  (4MB)        â”‚
â”‚                                                      â”‚
â”‚  å…± 2560 ä¸ªå¯¹è±¡ (10GB / 4MB)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å…ƒæ•°æ®å¯¹è±¡

```
Pool: rbd
  â”‚
  â”œâ”€ rbd_header.<image_id>          # Image å…ƒæ•°æ®
  â”‚  â€¢ size, features, flags
  â”‚  â€¢ object_prefix
  â”‚  â€¢ parent ä¿¡æ¯
  â”‚  â€¢ å¿«ç…§åˆ—è¡¨
  â”‚
  â”œâ”€ rbd_id.<image_name>            # Name â†’ ID æ˜ å°„
  â”‚
  â”œâ”€ rbd_object_map.<image_id>      # Object Map (å¯é€‰)
  â”‚  â€¢ æ¯ä¸ªå¯¹è±¡çš„çŠ¶æ€ä½å›¾
  â”‚  â€¢ EXISTS, PENDING, ...
  â”‚
  â”œâ”€ rbd_data.<image_id>.<object_no>  # å®é™…æ•°æ®
  â”‚
  â””â”€ rbd_directory                   # Image åˆ—è¡¨ç›®å½•
```

### 1.3 ç‰¹æ€§æ ‡å¿— (Features)

```cpp
// src/librbd/Features.h
enum {
  RBD_FEATURE_LAYERING            = (1<<0),  // åˆ†å±‚/å…‹éš†
  RBD_FEATURE_STRIPINGV2          = (1<<1),  // é«˜çº§æ¡å¸¦åŒ–
  RBD_FEATURE_EXCLUSIVE_LOCK      = (1<<2),  // æ’ä»–é”
  RBD_FEATURE_OBJECT_MAP          = (1<<3),  // å¯¹è±¡æ˜ å°„
  RBD_FEATURE_FAST_DIFF           = (1<<4),  // å¿«é€Ÿå·®å¼‚è®¡ç®—
  RBD_FEATURE_DEEP_FLATTEN        = (1<<5),  // æ·±åº¦æ‰å¹³åŒ–
  RBD_FEATURE_JOURNALING          = (1<<6),  // æ—¥å¿—è®°å½•
  RBD_FEATURE_DATA_POOL           = (1<<7),  // æ•°æ®æ± åˆ†ç¦»
  RBD_FEATURE_OPERATIONS          = (1<<8),  // æ“ä½œè®°å½•
  RBD_FEATURE_MIGRATING           = (1<<9),  // è¿ç§»æ ‡è®°
  RBD_FEATURE_NON_PRIMARY         = (1<<10), // éä¸»é•œåƒ
  RBD_FEATURE_DIRTY_CACHE         = (1<<11), // è„ç¼“å­˜
  RBD_FEATURE_ENCRYPTION          = (1<<12), // åŠ å¯†
};
```

---

## äºŒã€ä»£ç ç›®å½•ç»“æ„

### 2.1 src/librbd/ æ ¸å¿ƒç›®å½•

```
src/librbd/
â”œâ”€â”€ librbd.cc                    # C API å…¥å£ (7600+ è¡Œ)
â”œâ”€â”€ ImageCtx.h/cc                # Image ä¸Šä¸‹æ–‡ (æ ¸å¿ƒæ•°æ®ç»“æ„)
â”œâ”€â”€ ImageState.h/cc              # Image çŠ¶æ€æœº
â”œâ”€â”€ Operations.h/cc              # Image æ“ä½œ (resize, flatten, ...)
â”‚
â”œâ”€â”€ api/                         # é«˜å±‚ API
â”‚   â”œâ”€â”€ Image.h/cc              # Image ç®¡ç†
â”‚   â”œâ”€â”€ Io.h/cc                 # I/O æ“ä½œ
â”‚   â”œâ”€â”€ Snapshot.h/cc           # å¿«ç…§ç®¡ç†
â”‚   â”œâ”€â”€ Pool.h/cc               # Pool ç®¡ç†
â”‚   â”œâ”€â”€ Mirror.h/cc             # é•œåƒå¤åˆ¶
â”‚   â”œâ”€â”€ Migration.h/cc          # è¿ç§»åŠŸèƒ½
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ io/                          # I/O è·¯å¾„ (49 æ–‡ä»¶)
â”‚   â”œâ”€â”€ ImageRequest.h/cc       # Image å±‚è¯·æ±‚
â”‚   â”œâ”€â”€ ObjectRequest.h/cc      # Object å±‚è¯·æ±‚
â”‚   â”œâ”€â”€ ImageDispatcher.h/cc    # Image I/O è°ƒåº¦
â”‚   â”œâ”€â”€ ObjectDispatcher.h/cc   # Object I/O è°ƒåº¦
â”‚   â”œâ”€â”€ AioCompletion.h/cc      # å¼‚æ­¥ I/O å®Œæˆ
â”‚   â”œâ”€â”€ CopyupRequest.h/cc      # Copyup è¯·æ±‚ (åˆ†å±‚)
â”‚   â”œâ”€â”€ QosImageDispatch.h/cc   # QoS è°ƒåº¦
â”‚   â”œâ”€â”€ Types.h                 # I/O ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ cache/                       # ç¼“å­˜å±‚
â”‚   â”œâ”€â”€ pwl/                    # Persistent Write Log (47 æ–‡ä»¶)
â”‚   â”‚   â”œâ”€â”€ WriteLog.h/cc       # æŒä¹…åŒ–å†™æ—¥å¿—
â”‚   â”‚   â”œâ”€â”€ SyncPoint.h/cc      # åŒæ­¥ç‚¹
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ ImageWriteback.h/cc     # Image å›å†™
â”‚   â”œâ”€â”€ ObjectCacherObjectDispatch.h/cc
â”‚   â”œâ”€â”€ WriteLogImageDispatch.h/cc
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ exclusive_lock/              # æ’ä»–é” (8 æ–‡ä»¶)
â”‚   â”œâ”€â”€ AutomaticPolicy.h/cc    # è‡ªåŠ¨é”ç­–ç•¥
â”‚   â”œâ”€â”€ StandardPolicy.h/cc     # æ ‡å‡†é”ç­–ç•¥
â”‚   â”œâ”€â”€ PreAcquireRequest.h/cc  # è·å–é”å‰å¤„ç†
â”‚   â””â”€â”€ PostAcquireRequest.h/cc # è·å–é”åå¤„ç†
â”‚
â”œâ”€â”€ image/                       # Image æ“ä½œ (36 æ–‡ä»¶)
â”‚   â”œâ”€â”€ OpenRequest.h/cc        # æ‰“å¼€ Image
â”‚   â”œâ”€â”€ CloseRequest.h/cc       # å…³é—­ Image
â”‚   â”œâ”€â”€ CreateRequest.h/cc      # åˆ›å»º Image
â”‚   â”œâ”€â”€ RemoveRequest.h/cc      # åˆ é™¤ Image
â”‚   â”œâ”€â”€ ResizeRequest.h/cc      # è°ƒæ•´å¤§å°
â”‚   â”œâ”€â”€ RefreshRequest.h/cc     # åˆ·æ–°å…ƒæ•°æ®
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ operation/                   # æ“ä½œè¯·æ±‚ (40 æ–‡ä»¶)
â”‚   â”œâ”€â”€ SnapshotCreateRequest.h/cc
â”‚   â”œâ”€â”€ SnapshotRemoveRequest.h/cc
â”‚   â”œâ”€â”€ SnapshotRollbackRequest.h/cc
â”‚   â”œâ”€â”€ FlattenRequest.h/cc
â”‚   â”œâ”€â”€ RebuildObjectMapRequest.h/cc
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ journal/                     # æ—¥å¿— (25 æ–‡ä»¶)
â”‚   â”œâ”€â”€ Replay.h/cc             # æ—¥å¿—é‡æ”¾
â”‚   â”œâ”€â”€ Types.h                 # æ—¥å¿—ç±»å‹
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ mirror/                      # é•œåƒå¤åˆ¶ (43 æ–‡ä»¶)
â”‚   â”œâ”€â”€ ImageSync.h/cc          # Image åŒæ­¥
â”‚   â”œâ”€â”€ SnapshotCopyRequest.h/cc
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ object_map/                  # Object Map (27 æ–‡ä»¶)
â”‚   â”œâ”€â”€ CreateRequest.h/cc
â”‚   â”œâ”€â”€ UpdateRequest.h/cc
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ managed_lock/                # åˆ†å¸ƒå¼é” (13 æ–‡ä»¶)
â”‚   â”œâ”€â”€ AcquireRequest.h/cc     # è·å–é”
â”‚   â”œâ”€â”€ ReleaseRequest.h/cc     # é‡Šæ”¾é”
â”‚   â”œâ”€â”€ BreakRequest.h/cc       # æ‰“ç ´é”
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ crypto/                      # åŠ å¯† (24 æ–‡ä»¶)
â”‚   â”œâ”€â”€ luks/                   # LUKS åŠ å¯†
â”‚   â”œâ”€â”€ CryptoObjectDispatch.h/cc
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ deep_copy/                   # æ·±åº¦å¤åˆ¶ (17 æ–‡ä»¶)
â”‚   â”œâ”€â”€ ImageCopyRequest.h/cc
â”‚   â”œâ”€â”€ ObjectCopyRequest.h/cc
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ migration/                   # è¿ç§» (32 æ–‡ä»¶)
â”‚   â””â”€â”€ ...
â”‚
â””â”€â”€ trash/                       # å›æ”¶ç«™ (4 æ–‡ä»¶)
    â””â”€â”€ ...

æ€»è®¡ï¼š~265 ä¸ªå¤´æ–‡ä»¶ï¼Œ~250 ä¸ªæºæ–‡ä»¶
```

### 2.2 å†…æ ¸æ¨¡å—

```
drivers/block/rbd.c              # Linux å†…æ ¸ RBD é©±åŠ¨
  â€¢ çº¦ 7000+ è¡Œ C ä»£ç 
  â€¢ å®ç° /dev/rbd* å—è®¾å¤‡
  â€¢ ä½¿ç”¨ libceph é€šä¿¡
```

### 2.3 ç›¸å…³å·¥å…·

```
src/tools/rbd/
â”œâ”€â”€ action/
â”‚   â”œâ”€â”€ Bench.h/cc              # æ€§èƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ Clone.h/cc              # å…‹éš†
â”‚   â”œâ”€â”€ Create.h/cc             # åˆ›å»º
â”‚   â”œâ”€â”€ Export.h/cc             # å¯¼å‡º
â”‚   â”œâ”€â”€ Import.h/cc             # å¯¼å…¥
â”‚   â”œâ”€â”€ Snap.h/cc               # å¿«ç…§
â”‚   â””â”€â”€ ...
â””â”€â”€ Shell.cc                     # rbd å‘½ä»¤è¡Œå·¥å…·
```

---

## ä¸‰ã€æ ¸å¿ƒæ•°æ®ç»“æ„

### 3.1 ImageCtx (Image ä¸Šä¸‹æ–‡)

```cpp
// src/librbd/ImageCtx.h
struct ImageCtx {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // åŸºæœ¬ä¿¡æ¯
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  CephContext *cct;                     // Ceph ä¸Šä¸‹æ–‡
  
  std::string name;                     // Image åç§°
  std::string id;                       // Image ID (UUID)
  std::string header_oid;               // å¤´å¯¹è±¡å
  std::string object_prefix;            // å¯¹è±¡å‰ç¼€
  
  uint64_t size;                        // Image å¤§å°
  uint64_t features;                    // ç‰¹æ€§æ ‡å¿—
  uint8_t order;                        // å¯¹è±¡å¤§å° order (2^order)
  bool old_format;                      // æ˜¯å¦æ—§æ ¼å¼
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RADOS æ¥å£
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  librados::IoCtx data_ctx;             // æ•°æ® Pool
  librados::IoCtx md_ctx;               // å…ƒæ•°æ® Pool
  neorados::RADOS& rados_api;           // æ–° RADOS API
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // å¿«ç…§ç›¸å…³
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  ::SnapContext snapc;                  // å¿«ç…§ä¸Šä¸‹æ–‡
  std::vector<librados::snap_t> snaps;  // å¿«ç…§åˆ—è¡¨
  std::map<librados::snap_t, SnapInfo> snap_info;  // å¿«ç…§ä¿¡æ¯
  std::map<SnapKey, librados::snap_t> snap_ids;    // å¿«ç…§ ID æ˜ å°„
  uint64_t snap_id;                     // å½“å‰å¿«ç…§ ID
  bool snap_exists;                     // å¿«ç…§æ˜¯å¦å­˜åœ¨
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // åˆ†å±‚ (Layering)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  ParentImageInfo parent_md;            // çˆ¶é•œåƒä¿¡æ¯
  ImageCtx *parent;                     // çˆ¶ ImageCtx
  ImageCtx *child;                      // å­ ImageCtx
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // é”ä¸åŒæ­¥
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  ceph::shared_mutex owner_lock;        // æ‰€æœ‰æƒé”
  ceph::shared_mutex image_lock;        // Image é”
  ceph::shared_mutex timestamp_lock;    // æ—¶é—´æˆ³é”
  ceph::mutex async_ops_lock;           // å¼‚æ­¥æ“ä½œé”
  ceph::mutex copyup_list_lock;         // Copyup åˆ—è¡¨é”
  
  bool exclusive_locked;                // æ˜¯å¦æŒæœ‰æ’ä»–é”
  std::string lock_tag;                 // é”æ ‡ç­¾
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // I/O ç›¸å…³
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  io::ImageDispatcherInterface *io_image_dispatcher;
  io::ObjectDispatcherInterface *io_object_dispatcher;
  
  xlist<io::AsyncOperation*> async_ops;              // å¼‚æ­¥æ“ä½œ
  std::map<uint64_t, io::CopyupRequest*> copyup_list;  // Copyup è¯·æ±‚
  
  Readahead readahead;                  // é¢„è¯»
  std::atomic<uint64_t> total_bytes_read;
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ç»„ä»¶
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  ImageState *state;                    // çŠ¶æ€æœº
  Operations *operations;               // æ“ä½œ
  ExclusiveLock *exclusive_lock;        // æ’ä»–é”
  ObjectMap *object_map;                // å¯¹è±¡æ˜ å°„
  Journal *journal;                     // æ—¥å¿—
  ImageWatcher *image_watcher;          // è§‚å¯Ÿè€…
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // æ€§èƒ½è®¡æ•°å™¨
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  PerfCounters *perfcounter;            // æ€§èƒ½ç»Ÿè®¡
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // é«˜çº§ç‰¹æ€§
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  uint64_t stripe_unit, stripe_count;   // æ¡å¸¦åŒ–å‚æ•°
  uint64_t flags;                       // æ ‡å¿—
  uint64_t op_features;                 // æ“ä½œç‰¹æ€§
  
  file_layout_t layout;                 // æ–‡ä»¶å¸ƒå±€
  
  MigrationInfo migration_info;         // è¿ç§»ä¿¡æ¯
  cls::rbd::GroupSpec group_spec;       // ç»„ä¿¡æ¯
  
  crypto::EncryptionFormat* encryption_format;  // åŠ å¯†æ ¼å¼
};
```

### 3.2 I/O è¯·æ±‚ç»“æ„

```cpp
// src/librbd/io/ImageDispatchSpec.h
class ImageDispatchSpec {
  // I/O æ“ä½œç±»å‹
  struct Read {
    ReadResult read_result;
    int read_flags;
  };
  
  struct Write {
    bufferlist bl;
  };
  
  struct Discard {
    uint32_t discard_granularity_bytes;
  };
  
  struct WriteSame {
    bufferlist bl;
  };
  
  struct CompareAndWrite {
    bufferlist cmp_bl;
    bufferlist bl;
    uint64_t *mismatch_offset;
  };
  
  struct Flush {
    FlushSource flush_source;
  };
  
  struct ListSnaps {
    SnapIds snap_ids;
    int list_snaps_flags;
    SnapshotDelta* snapshot_delta;
  };
  
  // è¯·æ±‚å‚æ•°
  uint64_t offset;                      // åç§»é‡
  uint64_t length;                      // é•¿åº¦
  AioCompletion *aio_comp;              // å¼‚æ­¥å®Œæˆå›è°ƒ
  ZTracer::Trace trace;                 // Tracing
  
  // Variant ä¿å­˜å…·ä½“æ“ä½œ
  boost::variant<Read, Write, Discard, ...> request;
};
```

### 3.3 ObjectRequest (å¯¹è±¡è¯·æ±‚)

```cpp
// src/librbd/io/ObjectRequest.h
template <typename ImageCtxT>
class ObjectRequest {
protected:
  ImageCtxT *m_ictx;                    // Image ä¸Šä¸‹æ–‡
  uint64_t m_object_no;                 // å¯¹è±¡ç¼–å·
  IOContext m_io_context;               // I/O ä¸Šä¸‹æ–‡
  Context *m_completion;                // å®Œæˆå›è°ƒ
  ZTracer::Trace m_trace;               // Tracing
  
  bool m_has_parent;                    // æ˜¯å¦æœ‰çˆ¶é•œåƒ
  
public:
  virtual void send() = 0;              // å‘é€è¯·æ±‚
  virtual const char *get_op_type() const = 0;
  
  // å­ç±»ï¼š
  // â€¢ ObjectReadRequest
  // â€¢ ObjectWriteRequest
  // â€¢ ObjectDiscardRequest
  // â€¢ ObjectWriteSameRequest
  // â€¢ ObjectCompareAndWriteRequest
};
```

### 3.4 AioCompletion (å¼‚æ­¥å®Œæˆ)

```cpp
// src/librbd/io/AioCompletion.h
class AioCompletion {
  // å¼•ç”¨è®¡æ•°
  std::atomic<uint32_t> ref;
  std::atomic<uint32_t> rbd_comp_ref;
  
  // å›è°ƒ
  callback_t complete_cb;
  void *complete_arg;
  
  // çŠ¶æ€
  std::atomic<ssize_t> rval;            // è¿”å›å€¼
  std::atomic<int> error_rval;          // é”™è¯¯ç 
  std::atomic<uint32_t> state;          // çŠ¶æ€
  std::atomic<uint32_t> pending_count;  // å¾…å¤„ç†è®¡æ•°
  
  // è¯»å–ç»“æœ
  ReadResult read_result;
  
  // é”
  ceph::mutex lock;
  ceph::condition_variable cond;
  
public:
  void complete();                      // å®Œæˆ
  void wait_for_complete();             // ç­‰å¾…å®Œæˆ
  ssize_t get_return_value();           // è·å–è¿”å›å€¼
  
  void add_request();                   // æ·»åŠ è¯·æ±‚
  void complete_request(ssize_t r);     // å®Œæˆè¯·æ±‚
};
```

---

## å››ã€I/O æ•°æ®è·¯å¾„

### 4.1 I/O è·¯å¾„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             I/O è¯·æ±‚å¤„ç†æµç¨‹                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åº”ç”¨å±‚ API è°ƒç”¨
   â”‚
   â”‚ rbd_write(image, offset, length, data)
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ librbd API å±‚ (librbd.cc)                                    â”‚
â”‚ â€¢ å‚æ•°éªŒè¯                                                   â”‚
â”‚ â€¢ åˆ›å»º AioCompletion                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ api::Io å±‚ (api/Io.cc)                                       â”‚
â”‚ â€¢ æ„é€  ImageDispatchSpec                                     â”‚
â”‚ â€¢ è°ƒç”¨ io_image_dispatcher->send()                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ImageDispatcher å±‚ (io/ImageDispatcher.cc)                  â”‚
â”‚                                                              â”‚
â”‚ è°ƒåº¦é“¾ï¼š                                                      â”‚
â”‚   ImageDispatch (é“¾å¼å¤„ç†å™¨)                                 â”‚
â”‚   â”œâ”€> QosImageDispatch          (QoS é™æµ)                  â”‚
â”‚   â”œâ”€> WriteBlockImageDispatch   (å†™é˜»å¡)                    â”‚
â”‚   â”œâ”€> RefreshImageDispatch      (å…ƒæ•°æ®åˆ·æ–°)                â”‚
â”‚   â”œâ”€> ExclusiveLockImageDispatch (æ’ä»–é”æ£€æŸ¥)               â”‚
â”‚   â”œâ”€> ObjectCacherObjectDispatch (å¯¹è±¡ç¼“å­˜)                 â”‚
â”‚   â”œâ”€> WriteLogImageDispatch     (æŒä¹…åŒ–å†™æ—¥å¿—)              â”‚
â”‚   â””â”€> CryptoObjectDispatch      (åŠ å¯†)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ImageRequest å±‚ (io/ImageRequest.cc)                        â”‚
â”‚ â€¢ åœ°å€æ˜ å°„ï¼šImage offset â†’ Object list                      â”‚
â”‚ â€¢ åˆ‡åˆ†è¯·æ±‚ä¸ºå¤šä¸ª ObjectRequest                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ObjectDispatcher å±‚ (io/ObjectDispatcher.cc)                â”‚
â”‚                                                              â”‚
â”‚ è°ƒåº¦é“¾ï¼š                                                      â”‚
â”‚   ObjectDispatch (é“¾å¼å¤„ç†å™¨)                                â”‚
â”‚   â”œâ”€> CryptoObjectDispatch       (åŠ å¯†)                     â”‚
â”‚   â”œâ”€> WriteAroundObjectDispatch  (å†™ç»•è¿‡)                   â”‚
â”‚   â””â”€> SimpleSchedulerObjectDispatch (è°ƒåº¦)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ObjectRequest å±‚ (io/ObjectRequest.cc)                      â”‚
â”‚ â€¢ å¤„ç†åˆ†å±‚ (Layering)                                        â”‚
â”‚ â€¢ å¤„ç† Copyup                                                â”‚
â”‚ â€¢ æ›´æ–° Object Map                                            â”‚
â”‚ â€¢ æ„é€  librados::ObjectWriteOperation                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ librados (å®¢æˆ·ç«¯åº“)                                          â”‚
â”‚ â€¢ CRUSH è®¡ç®—                                                 â”‚
â”‚ â€¢ è¿æ¥ OSD                                                   â”‚
â”‚ â€¢ å‘é€ RADOS æ“ä½œ                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                     OSD é›†ç¾¤
```

### 4.2 å†™å…¥æµç¨‹è¯¦è§£

```cpp
// ç¬¬ä¸€æ­¥ï¼šAPI è°ƒç”¨
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// librbd.cc
int rbd_write(rbd_image_t image, uint64_t ofs, size_t len,
              const char *buf)
{
  librbd::ImageCtx *ictx = (librbd::ImageCtx *)image;
  
  // åˆ›å»ºå¼‚æ­¥å®Œæˆå¯¹è±¡
  librbd::RBD::AioCompletion *c = new librbd::RBD::AioCompletion();
  
  // å¼‚æ­¥å†™å…¥
  int r = librbd::api::Io<>::aio_write(
    *ictx, c->pc, ofs, len, bufferlist::static_from_mem(buf, len),
    0, true);
  
  // ç­‰å¾…å®Œæˆ
  if (r == 0) {
    c->wait_for_complete();
    r = c->get_return_value();
  }
  
  c->release();
  return r;
}

// ç¬¬äºŒæ­¥ï¼šæ„é€  ImageDispatchSpec
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// api/Io.cc
void aio_write(ImageCtx& ictx, AioCompletion* aio_comp,
               uint64_t off, uint64_t len, bufferlist&& bl, int op_flags)
{
  // åˆ›å»º ImageDispatchSpec
  auto req = io::ImageDispatchSpec::create_write(
    ictx, io::IMAGE_DISPATCH_LAYER_API_START, aio_comp,
    {{off, len}}, std::move(bl), op_flags, {});
  
  // å‘é€åˆ° ImageDispatcher
  req->send();
}

// ç¬¬ä¸‰æ­¥ï¼šImageDispatcher è°ƒåº¦
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// io/ImageDispatcher.cc
void ImageDispatcher::send(ImageDispatchSpec* spec) {
  // éå† Dispatch é“¾
  for (auto dispatch : m_dispatches) {
    if (dispatch->write(...)) {
      // æŸä¸ª Dispatch å¤„ç†äº†è¯·æ±‚
      return;
    }
  }
  
  // æœ€ç»ˆåˆ°è¾¾ ImageDispatch
  // è½¬å‘åˆ° ImageRequest
  auto req = ImageRequest::create_write_request(
    ictx, spec->aio_comp, spec->image_extents, ...);
  req->send();
}

// ç¬¬å››æ­¥ï¼šImage â†’ Object æ˜ å°„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// io/ImageRequest.cc
void ImageWriteRequest::send_request() {
  // è®¡ç®—æ¶‰åŠçš„å¯¹è±¡
  // offset = 8MB, length = 8MB
  // object_size = 4MB (order=22, 2^22=4MB)
  
  // å¯¹è±¡ 2: [8MB, 12MB)  -> [0, 4MB)
  // å¯¹è±¡ 3: [12MB, 16MB) -> [0, 4MB)
  
  for (auto& extent : m_object_extents) {
    // åˆ›å»º ObjectRequest
    auto req = ObjectRequest::create_write(
      m_ictx, extent.object_no, extent.object_off,
      std::move(extent.bl), m_io_context, op_flags, ...);
    
    // å‘é€ ObjectRequest
    req->send();
  }
}

// ç¬¬äº”æ­¥ï¼šObjectRequest å¤„ç†
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// io/ObjectRequest.cc
void ObjectWriteRequest::send() {
  // æ£€æŸ¥æ˜¯å¦éœ€è¦ Copyup (åˆ†å±‚)
  if (has_parent() && !object_exists) {
    // éœ€è¦å…ˆä»çˆ¶é•œåƒè¯»å–æ•°æ®
    pre_write_object_map_update();
    copyup();
    return;
  }
  
  // æ›´æ–° Object Map (å¦‚æœå¯ç”¨)
  if (object_map_enabled) {
    pre_write_object_map_update();
  }
  
  // æ„é€  librados WriteOp
  neorados::WriteOp write_op;
  add_write_ops(&write_op);
  
  // å‘é€åˆ° RADOS
  auto comp = create_rados_callback();
  m_ictx->rados_api.execute(object_name, m_io_context,
                             std::move(write_op), comp);
}

// ç¬¬å…­æ­¥ï¼šlibrados å‘é€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// librados è´Ÿè´£ï¼š
// 1. CRUSH è®¡ç®—ï¼šobject â†’ PG â†’ OSDs
// 2. æ„é€  MOSDOp æ¶ˆæ¯
// 3. å‘é€åˆ° Primary OSD
// 4. ç­‰å¾…å‰¯æœ¬ç¡®è®¤
// 5. å›è°ƒ completion
```

### 4.3 è¯»å–æµç¨‹

```cpp
// è¯»å–æµç¨‹ç›¸å¯¹ç®€å• (æ— éœ€ Copyup)

// io/ObjectReadRequest.cc
void ObjectReadRequest::read_object() {
  // æ„é€  librados ReadOp
  neorados::ReadOp read_op;
  read_op.read(m_object_off, m_object_len, &m_read_data, nullptr);
  
  // å‘é€åˆ° RADOS (åªéœ€è®¿é—® Primary OSD)
  auto comp = create_rados_callback();
  m_ictx->rados_api.execute(object_name, m_io_context,
                             std::move(read_op), comp);
}

// å¦‚æœå¯¹è±¡ä¸å­˜åœ¨ä¸”æœ‰çˆ¶é•œåƒ
void ObjectReadRequest::read_parent() {
  // ä»çˆ¶é•œåƒè¯»å–
  if (m_ictx->parent) {
    // é€’å½’è¯»å–çˆ¶é•œåƒ
    auto req = ObjectReadRequest::create(
      m_ictx->parent, m_object_no, &extents, ...);
    req->send();
  }
}

// å¯é€‰ï¼šè§¦å‘ Copyup (å°†çˆ¶é•œåƒæ•°æ®å¤åˆ¶åˆ°å­é•œåƒ)
void ObjectReadRequest::copyup() {
  auto req = CopyupRequest::create(m_ictx, m_object_no, ...);
  req->send();
}
```

### 4.4 åœ°å€æ˜ å°„ç®—æ³•

```cpp
// å°† Image åç§»è½¬æ¢ä¸º Object ç¼–å·å’Œåç§»

uint64_t image_offset = 10 * 1024 * 1024;  // 10 MB
uint64_t length = 8 * 1024 * 1024;         // 8 MB
uint8_t order = 22;                        // 4 MB objects (2^22)
uint64_t object_size = 1ULL << order;      // 4 MB

// è®¡ç®—èµ·å§‹å¯¹è±¡
uint64_t start_object_no = image_offset >> order;
// = 10MB >> 22 = 2

// è®¡ç®—å¯¹è±¡å†…åç§»
uint64_t start_object_off = image_offset & (object_size - 1);
// = 10MB & (4MB - 1) = 2 MB

// è®¡ç®—ç»“æŸå¯¹è±¡
uint64_t end_object_no = (image_offset + length - 1) >> order;
// = (10MB + 8MB - 1) >> 22 = 4

// ç»“æœï¼šæ¶‰åŠå¯¹è±¡ 2, 3, 4
// å¯¹è±¡ 2: [2MB, 4MB)  - 2 MB æ•°æ®
// å¯¹è±¡ 3: [0, 4MB)    - 4 MB æ•°æ®
// å¯¹è±¡ 4: [0, 2MB)    - 2 MB æ•°æ®
```

---

## äº”ã€å¿«ç…§ä¸å…‹éš†

### 5.1 å¿«ç…§æœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RBD å¿«ç…§åŸç†                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Image çŠ¶æ€ï¼š
  size = 10 GB
  snapshots = []
  
  rbd_data.<id>.0000000000  (RADOS å¯¹è±¡)
  rbd_data.<id>.0000000001
  ...

åˆ›å»ºå¿«ç…§ snap1ï¼š
  $ rbd snap create pool/image@snap1

æ­¥éª¤ï¼š
1. å†»ç»“ I/O (å¯é€‰)
2. åˆ›å»º RADOS å¿«ç…§
   â€¢ data_ctx.snap_create("snap1")
   â€¢ å¯¹æ‰€æœ‰å¯¹è±¡åˆ›å»ºå¿«ç…§
3. æ›´æ–°å…ƒæ•°æ®
   â€¢ åœ¨ rbd_header ä¸­æ·»åŠ å¿«ç…§å…ƒæ•°æ®
   â€¢ snap_id = 10
   â€¢ snap_name = "snap1"
   â€¢ snap_namespace = user
   â€¢ size = 10 GB
   â€¢ timestamp
4. æ›´æ–° SnapContext
   â€¢ snapc.snaps = [10]
   â€¢ snapc.seq = 10
5. æ¢å¤ I/O
```

#### å¿«ç…§åå†™å…¥

```
å®¢æˆ·ç«¯å†™å…¥åˆ° HEAD (æ´»åŠ¨é•œåƒ)ï¼š

1. librados::ObjectWriteOperation op;
   
2. è®¾ç½®å¿«ç…§ä¸Šä¸‹æ–‡
   op.set_snap_context(snapc);
   // snapc = {seq: 10, snaps: [10]}
   
3. å†™å…¥æ“ä½œ
   op.write(offset, data);
   
4. OSD å¤„ç†ï¼š
   â€¢ æ£€æŸ¥å¯¹è±¡æ˜¯å¦æœ‰å¿«ç…§
   â€¢ å¦‚æœæœ‰ï¼Œå…ˆæ‰§è¡Œ COW (Copy-on-Write)
     - å…‹éš†å¯¹è±¡åˆ°å¿«ç…§ 10
     - ç„¶åå†™å…¥æ–°æ•°æ®åˆ° HEAD
   â€¢ å¦‚æœæ²¡æœ‰ï¼Œç›´æ¥å†™å…¥ HEAD
```

### 5.2 å…‹éš†æœºåˆ¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RBD å…‹éš† (åˆ†å±‚)                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤ 1ï¼šä¿æŠ¤å¿«ç…§
  $ rbd snap protect pool/parent@snap1
  
  â€¢ æ ‡è®°å¿«ç…§ä¸º protected
  â€¢ é˜²æ­¢è¢«åˆ é™¤

æ­¥éª¤ 2ï¼šåˆ›å»ºå…‹éš†
  $ rbd clone pool/parent@snap1 pool/child
  
  â€¢ åˆ›å»ºæ–° Image (child)
  â€¢ è®¾ç½® parent å…ƒæ•°æ®ï¼š
    - parent_pool = pool
    - parent_image_id = parent_id
    - parent_snap_id = snap1_id
    - parent_overlap = 10 GB
  â€¢ child æ²¡æœ‰å®é™…æ•°æ®å¯¹è±¡

æ­¥éª¤ 3ï¼šè¯»å–å…‹éš†
  åº”ç”¨è¯»å– pool/child@HEAD[offset=5MB, len=4MB]
  
  1. ObjectReadRequest::read_object()
     â€¢ å°è¯•ä» rbd_data.<child_id>.0000001 è¯»å–
     â€¢ å¯¹è±¡ä¸å­˜åœ¨ â†’ -ENOENT
  
  2. ObjectReadRequest::read_parent()
     â€¢ æ£€æŸ¥ has_parent() â†’ true
     â€¢ æ£€æŸ¥ offset < parent_overlap â†’ true
     â€¢ ä» parent@snap1 è¯»å–ï¼š
       m_ictx->parent->aio_read(..., snap_id=snap1_id)
  
  3. è¿”å›çˆ¶é•œåƒæ•°æ®

æ­¥éª¤ 4ï¼šå†™å…¥å…‹éš† (Copyup)
  åº”ç”¨å†™å…¥ pool/child@HEAD[offset=5MB, len=1MB]
  
  1. ObjectWriteRequest::send()
     â€¢ æ£€æŸ¥ has_parent() && !object_exists â†’ true
     â€¢ éœ€è¦ Copyup
  
  2. CopyupRequest::send()
     a) ä»çˆ¶é•œåƒè¯»å–æ•´ä¸ªå¯¹è±¡ (4MB)
        read_from_parent(rbd_data.<parent_id>.0000001@snap1)
     
     b) åˆå¹¶æ–°æ•°æ®
        data[0:5MB] = parent_data[0:5MB]  (ä¿æŒä¸å˜)
        data[5MB:6MB] = new_data          (æ–°å†™å…¥)
        data[6MB:4MB] = parent_data[6MB:4MB]  (ä¿æŒä¸å˜)
     
     c) å†™å…¥åˆ°å­é•œåƒ
        write(rbd_data.<child_id>.0000001, data)
     
     d) æ›´æ–° Object Map
        object_map[1] = OBJECT_EXISTS
  
  3. å®Œæˆ
     â€¢ å­é•œåƒç°åœ¨æ‹¥æœ‰è¯¥å¯¹è±¡çš„å®Œæ•´å‰¯æœ¬
     â€¢ åç»­è¯»å†™ç›´æ¥è®¿é—®å­é•œåƒï¼Œæ— éœ€è®¿é—®çˆ¶é•œåƒ
```

#### Flatten (æ‰å¹³åŒ–)

```
å°†å…‹éš†è½¬æ¢ä¸ºç‹¬ç«‹é•œåƒï¼š

$ rbd flatten pool/child

è¿‡ç¨‹ï¼š
1. éå†æ‰€æœ‰å¯¹è±¡
   for object_no in range(0, total_objects):
     if not object_exists(object_no):
       if object_no < parent_overlap:
         # éœ€è¦ä»çˆ¶é•œåƒå¤åˆ¶
         copyup_from_parent(object_no)

2. ç§»é™¤çˆ¶é•œåƒå¼•ç”¨
   â€¢ parent_md = NULL
   â€¢ parent_overlap = 0

3. ç»“æœ
   â€¢ child ç°åœ¨æ˜¯å®Œå…¨ç‹¬ç«‹çš„é•œåƒ
   â€¢ å¯ä»¥åˆ é™¤çˆ¶é•œåƒçš„å¿«ç…§ä¿æŠ¤
```

---

## å…­ã€ç¼“å­˜æœºåˆ¶

### 6.1 Object Cacher

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Object Cacher æ¶æ„                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

librbd I/O
   â”‚
   â–¼
ObjectCacherObjectDispatch
   â”‚
   â”œâ”€ å‘½ä¸­ç¼“å­˜ â†’ ç›´æ¥è¿”å›
   â”‚
   â””â”€ æœªå‘½ä¸­ â†’ ä» OSD è¯»å– â†’ å¡«å……ç¼“å­˜
   
ç¼“å­˜ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ObjectCacher                          â”‚
â”‚                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Object 1    â”‚  â”‚ Object 2    â”‚   â”‚
â”‚ â”‚             â”‚  â”‚             â”‚   â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚ â”‚ â”‚ Buffer  â”‚ â”‚  â”‚ â”‚ Buffer  â”‚ â”‚   â”‚
â”‚ â”‚ â”‚ [0, 64K]â”‚ â”‚  â”‚ â”‚ [0, 64K]â”‚ â”‚   â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚ â”‚ â”‚ Buffer  â”‚ â”‚  â”‚ â”‚ Buffer  â”‚ â”‚   â”‚
â”‚ â”‚ â”‚[64K,128K]â”‚ â”‚ â”‚[128K,192K]â”‚   â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼š
â€¢ ç¼“å­˜ç²’åº¦ï¼š64KB
â€¢ LRU æ·˜æ±°ç­–ç•¥
â€¢ å†™å› (writeback) æˆ–å†™é€š (writethrough)
â€¢ è„é¡µè·Ÿè¸ª
```

### 6.2 Persistent Write Log (PWL)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PWL (æŒä¹…åŒ–å†™æ—¥å¿—) - RBD 19.x æ–°ç‰¹æ€§                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç›®çš„ï¼š
â€¢ å°†å†™å…¥å…ˆæŒä¹…åŒ–åˆ°æœ¬åœ° SSD/PMEM
â€¢ å¼‚æ­¥åˆ·æ–°åˆ° RADOS
â€¢ é™ä½å†™å»¶è¿Ÿï¼Œæé«˜æ€§èƒ½

æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åº”ç”¨å†™å…¥                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WriteLogImageDispatch                                     â”‚
â”‚                                                           â”‚
â”‚ 1. åˆ†é…æ—¥å¿—æ¡ç›®                                           â”‚
â”‚ 2. å†™å…¥æœ¬åœ° SSD/PMEM (WriteLog)                          â”‚
â”‚ 3. è¿”å›ç»™åº”ç”¨ âœ“                                          â”‚
â”‚                                                           â”‚
â”‚ åå°çº¿ç¨‹ï¼š                                                â”‚
â”‚ 4. æ‰¹é‡åˆ·æ–°åˆ° RADOS                                       â”‚
â”‚ 5. é‡Šæ”¾æ—¥å¿—ç©ºé—´                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

WriteLog ç»“æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WriteLog (ç¯å½¢ç¼“å†²åŒº)                                     â”‚
â”‚                                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚ â”‚ Entry 1   â”‚ â”‚ Entry 2   â”‚ â”‚ Entry 3   â”‚ ...          â”‚
â”‚ â”‚ offset    â”‚ â”‚ offset    â”‚ â”‚ offset    â”‚              â”‚
â”‚ â”‚ length    â”‚ â”‚ length    â”‚ â”‚ length    â”‚              â”‚
â”‚ â”‚ data      â”‚ â”‚ data      â”‚ â”‚ data      â”‚              â”‚
â”‚ â”‚ checksum  â”‚ â”‚ checksum  â”‚ â”‚ checksum  â”‚              â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                           â”‚
â”‚ åŒæ­¥ç‚¹ (Sync Point)ï¼š                                     â”‚
â”‚ â€¢ å®šæœŸåˆ›å»º                                                â”‚
â”‚ â€¢ æ ‡è®°ä¸€è‡´æ€§è¾¹ç•Œ                                          â”‚
â”‚ â€¢ ç”¨äºå´©æºƒæ¢å¤                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€§èƒ½æå‡ï¼š
â€¢ å†™å»¶è¿Ÿï¼š~100us (vs ~2ms)
â€¢ å†™ IOPSï¼š~50K (vs ~5K)
â€¢ é€‚ç”¨åœºæ™¯ï¼šå†™å¯†é›†å‹å·¥ä½œè´Ÿè½½
```

---

## ä¸ƒã€é•œåƒä¸å¤åˆ¶

### 7.1 RBD Mirroring

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RBD Mirroring æ¶æ„                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸¤ç§æ¨¡å¼ï¼š

1. Journal-based Mirroring (åŸºäºæ—¥å¿—)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   
   ä¸»é›†ç¾¤                              å¤‡é›†ç¾¤
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Image (RW)   â”‚                  â”‚ Image (RO)   â”‚
   â”‚   â”‚          â”‚                  â”‚              â”‚
   â”‚   â”‚ write    â”‚                  â”‚              â”‚
   â”‚   â–¼          â”‚                  â”‚              â”‚
   â”‚ Journal      â”‚  â”€â”€â”€â”€â”€å¤åˆ¶â”€â”€â”€â”€â”€> â”‚ é‡æ”¾æ—¥å¿—     â”‚
   â”‚ (è®°å½•æ“ä½œ)   â”‚                  â”‚              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   ç‰¹ç‚¹ï¼š
   â€¢ è¿‘å®æ—¶å¤åˆ¶ (ç§’çº§å»¶è¿Ÿ)
   â€¢ ä¿è¯é¡ºåº
   â€¢ éœ€è¦ JOURNALING ç‰¹æ€§
   â€¢ æ›´å¤šå¼€é”€

2. Snapshot-based Mirroring (åŸºäºå¿«ç…§)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   
   ä¸»é›†ç¾¤                              å¤‡é›†ç¾¤
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Image        â”‚                  â”‚ Image        â”‚
   â”‚   â”‚          â”‚                  â”‚              â”‚
   â”‚   â”‚ å‘¨æœŸå¿«ç…§  â”‚                  â”‚              â”‚
   â”‚   â–¼          â”‚                  â”‚              â”‚
   â”‚ snap_1       â”‚  â”€â”€â”€â”€â”€å¤åˆ¶â”€â”€â”€â”€â”€> â”‚ æ¥æ”¶å¿«ç…§     â”‚
   â”‚ snap_2       â”‚                  â”‚              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   ç‰¹ç‚¹ï¼š
   â€¢ å®šæœŸå¤åˆ¶ (åˆ†é’Ÿçº§å»¶è¿Ÿ)
   â€¢ å¢é‡ä¼ è¾“ (ä»…å·®å¼‚)
   â€¢ æ— éœ€ JOURNALING
   â€¢ å¼€é”€è¾ƒå°
```

### 7.2 Journal å®ç°

```cpp
// src/librbd/journal/

Journal å†™å…¥æµç¨‹ï¼š
1. åº”ç”¨å†™å…¥ â†’ Image I/O
2. ExclusiveLockImageDispatch æ£€æŸ¥é”
3. Journal::append_write_event()
   â€¢ åºåˆ—åŒ– WriteEvent
   â€¢ å†™å…¥ Journal å¯¹è±¡
4. ç­‰å¾… Journal æŒä¹…åŒ–
5. æ‰§è¡Œå®é™… I/O
6. å®Œæˆ

Journal å¯¹è±¡å­˜å‚¨ï¼š
Pool: rbd
  â””â”€ journal.<image_id>
     â”œâ”€ journal_data.<image_id>.0000000000000000
     â”œâ”€ journal_data.<image_id>.0000000000000001
     â”œâ”€ journal_data.<image_id>.0000000000000002
     â””â”€ ...

äº‹ä»¶ç±»å‹ï¼š
enum EventType {
  EVENT_TYPE_AIO_DISCARD,        // Discard æ“ä½œ
  EVENT_TYPE_AIO_WRITE,          // Write æ“ä½œ
  EVENT_TYPE_AIO_FLUSH,          // Flush æ“ä½œ
  EVENT_TYPE_OP_FINISH,          // æ“ä½œå®Œæˆ
  EVENT_TYPE_SNAP_CREATE,        // å¿«ç…§åˆ›å»º
  EVENT_TYPE_SNAP_REMOVE,        // å¿«ç…§åˆ é™¤
  EVENT_TYPE_SNAP_RENAME,        // å¿«ç…§é‡å‘½å
  EVENT_TYPE_SNAP_PROTECT,       // å¿«ç…§ä¿æŠ¤
  EVENT_TYPE_SNAP_UNPROTECT,     // å¿«ç…§è§£é™¤ä¿æŠ¤
  EVENT_TYPE_SNAP_ROLLBACK,      // å¿«ç…§å›æ»š
  EVENT_TYPE_RENAME,             // é‡å‘½å
  EVENT_TYPE_RESIZE,             // è°ƒæ•´å¤§å°
  EVENT_TYPE_FLATTEN,            // æ‰å¹³åŒ–
};
```

### 7.3 é•œåƒåŒæ­¥

```cpp
// src/librbd/mirror/ImageSync.cc

åŒæ­¥æµç¨‹ï¼š
1. åˆ›å»ºæœ¬åœ° Image (å¦‚æœä¸å­˜åœ¨)
2. å¤åˆ¶å¿«ç…§
   for each snapshot in source:
     â€¢ åˆ›å»ºæœ¬åœ°å¿«ç…§
     â€¢ è®¡ç®—å·®å¼‚ (diff)
     â€¢ å¤åˆ¶å¯¹è±¡
3. å¤åˆ¶ HEAD (å½“å‰çŠ¶æ€)
4. å®Œæˆ

å¢é‡å¤åˆ¶ï¼š
â€¢ ä½¿ç”¨ diff_iterate è®¡ç®—å·®å¼‚
â€¢ åªå¤åˆ¶å˜åŒ–çš„æ•°æ®å—
â€¢ æ˜¾è‘—å‡å°‘ç½‘ç»œä¼ è¾“

ç¤ºä¾‹ï¼š
  æºé•œåƒï¼š10 GBï¼Œå˜åŒ– 100 MB
  å…¨é‡å¤åˆ¶ï¼š10 GB ç½‘ç»œä¼ è¾“
  å¢é‡å¤åˆ¶ï¼š100 MB ç½‘ç»œä¼ è¾“ (èŠ‚çœ 99%)
```

---

## å…«ã€æ€§èƒ½ä¼˜åŒ–

### 8.1 Object Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Object Map - å¯¹è±¡çŠ¶æ€ä½å›¾                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç›®çš„ï¼š
â€¢ è·Ÿè¸ªæ¯ä¸ªå¯¹è±¡çš„çŠ¶æ€
â€¢ ä¼˜åŒ–æ“ä½œæ€§èƒ½

çŠ¶æ€ï¼š
enum ObjectState {
  OBJECT_NONEXISTENT = 0,      // å¯¹è±¡ä¸å­˜åœ¨
  OBJECT_EXISTS = 1,           // å¯¹è±¡å­˜åœ¨
  OBJECT_PENDING = 2,          // å¯¹è±¡æ“ä½œä¸­
  OBJECT_EXISTS_CLEAN = 3,     // å¯¹è±¡å­˜åœ¨ä¸”å¹²å‡€
};

å­˜å‚¨ï¼š
Pool: rbd
  â””â”€ rbd_object_map.<image_id>
     â€¢ BitVector<2>              // æ¯ä¸ªå¯¹è±¡ 2 bit
     â€¢ 10GB Image (4MB å¯¹è±¡) â†’ 2560 å¯¹è±¡ â†’ 640 å­—èŠ‚

ä¼˜åŒ–åœºæ™¯ï¼š

1. Resize (ç¼©å°)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Without Object Map:
   â€¢ éœ€è¦åˆ é™¤æ‰€æœ‰è¶…å‡ºèŒƒå›´çš„å¯¹è±¡
   â€¢ å³ä½¿å¯¹è±¡ä¸å­˜åœ¨ï¼Œä¹Ÿè¦å°è¯•åˆ é™¤
   â€¢ æ—¶é—´ï¼šO(n) RADOS æ“ä½œ
   
   With Object Map:
   â€¢ æŸ¥è¯¢ Object Map
   â€¢ åªåˆ é™¤ EXISTS çŠ¶æ€çš„å¯¹è±¡
   â€¢ æ—¶é—´ï¼šO(m)ï¼Œm = å®é™…å­˜åœ¨çš„å¯¹è±¡æ•°

2. Delete (åˆ é™¤ Image)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Without Object Map:
   â€¢ å°è¯•åˆ é™¤æ‰€æœ‰å¯èƒ½çš„å¯¹è±¡ (0 åˆ° max_object)
   â€¢ ç¨€ç–é•œåƒä¼šæœ‰å¤§é‡å¤±è´¥æ“ä½œ
   
   With Object Map:
   â€¢ åªåˆ é™¤ EXISTS çŠ¶æ€çš„å¯¹è±¡
   â€¢ æ˜¾è‘—åŠ é€Ÿ

3. Diff (å·®å¼‚è®¡ç®—)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Without Object Map:
   â€¢ éœ€è¦æŸ¥è¯¢æ¯ä¸ªå¯¹è±¡çš„ stat
   â€¢ å¤§é‡ RADOS æ“ä½œ
   
   With Object Map:
   â€¢ ç›´æ¥è¯»å– Object Map
   â€¢ å¿«é€Ÿç¡®å®šå˜åŒ–å¯¹è±¡
```

### 8.2 Exclusive Lock

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Exclusive Lock - æ’ä»–é”                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç›®çš„ï¼š
â€¢ ä¿è¯åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯å¯ä»¥å†™å…¥
â€¢ æ”¯æŒé«˜çº§ç‰¹æ€§ï¼ˆObject Map, Journal, Mirroringï¼‰

å®ç°ï¼š
â€¢ åŸºäº cls_lock (RADOS å¯¹è±¡é”)
â€¢ å­˜å‚¨åœ¨ rbd_header.<image_id>

çŠ¶æ€æœºï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UNLOCKED  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚ acquire_lock()
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ACQUIRING  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚ success
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  <â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LOCKED   â”‚          â”‚ reacquire_lock()
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜          â”‚
       â”‚ release_lock() â”‚
       â–¼                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ RELEASING  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç­–ç•¥ï¼š

1. AutomaticPolicy (è‡ªåŠ¨)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â€¢ å®¢æˆ·ç«¯æ‰“å¼€ Image æ—¶è‡ªåŠ¨è·å–é”
   â€¢ I/O æ“ä½œå‰æ£€æŸ¥é”
   â€¢ å¤±å»é”æ—¶è‡ªåŠ¨é‡æ–°è·å–

2. StandardPolicy (æ ‡å‡†)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â€¢ éœ€è¦æ˜¾å¼è·å–é”
   â€¢ é€‚ç”¨äºæ‰‹åŠ¨æ§åˆ¶åœºæ™¯

é”åŠ«æŒ (Lock Breaking)ï¼š
â€¢ å¦‚æœé”æŒæœ‰è€…å´©æºƒ
â€¢ å…¶ä»–å®¢æˆ·ç«¯å¯ä»¥æ‰“ç ´é”
â€¢ é€šè¿‡é»‘åå•æœºåˆ¶é˜²æ­¢å†²çª
```

### 8.3 QoS (æœåŠ¡è´¨é‡)

```cpp
// src/librbd/io/QosImageDispatch.cc

QoS é™åˆ¶ï¼š

1. IOPS é™åˆ¶
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â€¢ rbd_qos_iops_limit = 1000
   â€¢ æ¯ç§’æœ€å¤š 1000 ä¸ª I/O æ“ä½œ

2. å¸¦å®½é™åˆ¶
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â€¢ rbd_qos_bps_limit = 100 MB/s
   â€¢ æ¯ç§’æœ€å¤š 100 MB æ•°æ®ä¼ è¾“

3. è¯»å†™åˆ†ç¦»é™åˆ¶
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â€¢ rbd_qos_read_iops_limit
   â€¢ rbd_qos_write_iops_limit
   â€¢ rbd_qos_read_bps_limit
   â€¢ rbd_qos_write_bps_limit

å®ç°ï¼š
â€¢ Token Bucket ç®—æ³•
â€¢ åœ¨ ImageDispatch å±‚æ‹¦æˆª
â€¢ è¶…é™è¯·æ±‚æ’é˜Ÿç­‰å¾…
```

### 8.4 é¢„è¯» (Readahead)

```cpp
// ImageCtx::readahead

Readahead readahead;

é…ç½®ï¼š
â€¢ rbd_readahead_trigger_requests = 10
  - è¿ç»­ 10 æ¬¡é¡ºåºè¯»å–åè§¦å‘é¢„è¯»

â€¢ rbd_readahead_max_bytes = 512 KB
  - æœ€å¤§é¢„è¯»å­—èŠ‚æ•°

â€¢ rbd_readahead_disable_after_bytes = 50 MB
  - è¯»å–è¶…è¿‡ 50 MB åç¦ç”¨é¢„è¯»

ç­–ç•¥ï¼š
1. æ£€æµ‹é¡ºåºè¯»å–æ¨¡å¼
2. é¢„è¯»åç»­æ•°æ®å—
3. å¡«å…… Object Cacher
4. æé«˜é¡ºåºè¯»å–æ€§èƒ½
```

### 8.5 æ€§èƒ½è®¡æ•°å™¨

```cpp
// src/librbd/Types.h

enum {
  l_librbd_rd,               // è¯»æ“ä½œæ•°
  l_librbd_rd_bytes,         // è¯»å­—èŠ‚æ•°
  l_librbd_rd_latency,       // è¯»å»¶è¿Ÿ
  
  l_librbd_wr,               // å†™æ“ä½œæ•°
  l_librbd_wr_bytes,         // å†™å­—èŠ‚æ•°
  l_librbd_wr_latency,       // å†™å»¶è¿Ÿ
  
  l_librbd_discard,          // Discard æ“ä½œæ•°
  l_librbd_discard_bytes,    // Discard å­—èŠ‚æ•°
  l_librbd_discard_latency,  // Discard å»¶è¿Ÿ
  
  l_librbd_flush,            // Flush æ“ä½œæ•°
  l_librbd_flush_latency,    // Flush å»¶è¿Ÿ
  
  l_librbd_ws,               // WriteSame æ“ä½œæ•°
  l_librbd_ws_bytes,         // WriteSame å­—èŠ‚æ•°
  l_librbd_ws_latency,       // WriteSame å»¶è¿Ÿ
  
  l_librbd_cmp,              // CompareAndWrite æ“ä½œæ•°
  l_librbd_cmp_bytes,        // CompareAndWrite å­—èŠ‚æ•°
  l_librbd_cmp_latency,      // CompareAndWrite å»¶è¿Ÿ
  
  l_librbd_snap_create,      // å¿«ç…§åˆ›å»º
  l_librbd_snap_remove,      // å¿«ç…§åˆ é™¤
  l_librbd_snap_rollback,    // å¿«ç…§å›æ»š
  
  l_librbd_readahead,        // é¢„è¯»æ“ä½œæ•°
  l_librbd_readahead_bytes,  // é¢„è¯»å­—èŠ‚æ•°
};

æŸ¥çœ‹ï¼š
$ ceph daemon /var/run/ceph/ceph-client.admin.*.asok \
  perf dump librbd
```

---

## ä¹ã€å…³é”®æ–‡ä»¶åˆ—è¡¨

### 9.1 æ ¸å¿ƒæ–‡ä»¶ (Top 20)

| æ–‡ä»¶ | è¡Œæ•° | åŠŸèƒ½ |
|------|------|------|
| `librbd.cc` | ~7600 | C API å…¥å£ |
| `io/ObjectRequest.cc` | ~2500 | å¯¹è±¡ I/O è¯·æ±‚ |
| `io/ImageRequest.cc` | ~2000 | Image I/O è¯·æ±‚ |
| `ImageCtx.cc` | ~1800 | Image ä¸Šä¸‹æ–‡å®ç° |
| `Operations.cc` | ~1500 | Image æ“ä½œ |
| `ImageState.cc` | ~1200 | Image çŠ¶æ€æœº |
| `ExclusiveLock.cc` | ~1100 | æ’ä»–é” |
| `Journal.cc` | ~1000 | æ—¥å¿— |
| `io/ImageDispatcher.cc` | ~900 | I/O è°ƒåº¦ |
| `io/AioCompletion.cc` | ~800 | å¼‚æ­¥å®Œæˆ |
| `ImageWatcher.cc` | ~800 | Image è§‚å¯Ÿè€… |
| `object_map/UpdateRequest.cc` | ~700 | Object Map æ›´æ–° |
| `cache/pwl/WriteLog.cc` | ~2000 | æŒä¹…åŒ–å†™æ—¥å¿— |
| `mirror/ImageSync.cc` | ~600 | é•œåƒåŒæ­¥ |
| `operation/SnapshotCreateRequest.cc` | ~500 | å¿«ç…§åˆ›å»º |
| `operation/ResizeRequest.cc` | ~600 | è°ƒæ•´å¤§å° |
| `operation/FlattenRequest.cc` | ~500 | æ‰å¹³åŒ– |
| `io/CopyupRequest.cc` | ~400 | Copyup è¯·æ±‚ |
| `api/Image.cc` | ~1000 | Image API |
| `api/Io.cc` | ~800 | I/O API |

### 9.2 ä»£ç ç»Ÿè®¡

```
ç›®å½•                    æ–‡ä»¶æ•°    ä»£ç è¡Œæ•°
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
librbd/                 ~50       ~25,000
librbd/io/              ~49       ~15,000
librbd/cache/           ~50       ~12,000
librbd/image/           ~36       ~8,000
librbd/operation/       ~40       ~10,000
librbd/journal/         ~25       ~6,000
librbd/mirror/          ~43       ~8,000
librbd/object_map/      ~27       ~5,000
librbd/exclusive_lock/  ~8        ~2,000
librbd/managed_lock/    ~13       ~3,000
librbd/api/             ~24       ~6,000
librbd/crypto/          ~24       ~4,000
librbd/deep_copy/       ~17       ~3,000
librbd/migration/       ~32       ~5,000
librbd/watcher/         ~7        ~2,000
librbd/trash/           ~4        ~1,000
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡                    ~500      ~120,000+
```

---

## åã€è°ƒè¯•ä¸ç›‘æ§

### 10.1 è°ƒè¯•é€‰é¡¹

```bash
# å¯ç”¨ RBD è°ƒè¯•æ—¥å¿—
ceph config set client debug_rbd 20

# å¯ç”¨ librbd è°ƒè¯•
export CEPH_ARGS="--debug-rbd=20 --debug-librbd=20"

# æŸ¥çœ‹ Image ä¿¡æ¯
rbd info pool/image
rbd diff pool/image
rbd du pool/image

# æŸ¥çœ‹ Image ç‰¹æ€§
rbd info pool/image | grep features

# æŸ¥çœ‹é”çŠ¶æ€
rbd lock list pool/image

# æŸ¥çœ‹å¿«ç…§
rbd snap ls pool/image
```

### 10.2 æ€§èƒ½æµ‹è¯•

```bash
# Bench æµ‹è¯•
rbd bench --io-type write --io-size 4K --io-total 1G pool/image
rbd bench --io-type read --io-size 4K --io-total 1G pool/image

# fio æµ‹è¯•
fio --name=randwrite --ioengine=rbd \
    --pool=rbd --rbdname=image \
    --rw=randwrite --bs=4k --size=1G \
    --numjobs=4 --time_based --runtime=60

# æŸ¥çœ‹æ€§èƒ½ç»Ÿè®¡
rbd perf image iostat
rbd perf image iotop
```

### 10.3 å¸¸è§é—®é¢˜

```
1. æ€§èƒ½é—®é¢˜
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â€¢ æ£€æŸ¥ Object Map æ˜¯å¦å¯ç”¨
   â€¢ æ£€æŸ¥æ˜¯å¦æœ‰ Copyup å¼€é”€
   â€¢ æ£€æŸ¥ QoS é™åˆ¶
   â€¢ æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ
   â€¢ æ£€æŸ¥ OSD æ€§èƒ½

2. ç©ºé—´é—®é¢˜
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â€¢ ä½¿ç”¨ du æŸ¥çœ‹å®é™…å ç”¨
   â€¢ æ£€æŸ¥å¿«ç…§å ç”¨ç©ºé—´
   â€¢ è€ƒè™‘ Flatten å…‹éš†
   â€¢ ä½¿ç”¨ Discard/TRIM

3. é”é—®é¢˜
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â€¢ æ£€æŸ¥è°æŒæœ‰é”
   â€¢ è€ƒè™‘æ‰“ç ´é” (break lock)
   â€¢ æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦å´©æºƒ

4. å…‹éš†æ€§èƒ½
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   â€¢ Copyup ä¼šå¯¼è‡´é¦–æ¬¡å†™å…¥å»¶è¿Ÿé«˜
   â€¢ è€ƒè™‘é¢„çƒ­ (æå‰ Copyup)
   â€¢ è€ƒè™‘ Flatten è½¬ä¸ºç‹¬ç«‹é•œåƒ
```

---

## åä¸€ã€æœ€ä½³å®è·µ

### 11.1 ç‰¹æ€§é€‰æ‹©

```
æ¨èç‰¹æ€§ç»„åˆï¼š

ç”Ÿäº§ç¯å¢ƒ (æ€§èƒ½ä¼˜å…ˆ)ï¼š
â”œâ”€ layering              âœ“ (æ”¯æŒå¿«ç…§/å…‹éš†)
â”œâ”€ exclusive-lock        âœ“ (å¤šå®¢æˆ·ç«¯åè°ƒ)
â”œâ”€ object-map            âœ“ (åŠ é€Ÿæ“ä½œ)
â”œâ”€ fast-diff             âœ“ (å¿«é€Ÿå·®å¼‚)
â””â”€ deep-flatten          âœ“ (å½»åº•æ‰å¹³åŒ–)

é•œåƒå¤åˆ¶ç¯å¢ƒï¼š
â”œâ”€ ä¸Šè¿°æ‰€æœ‰ç‰¹æ€§
â””â”€ journaling            âœ“ (è¿‘å®æ—¶å¤åˆ¶)

æœ€å°åŒ–ç‰¹æ€§ (å…¼å®¹æ€§ä¼˜å…ˆ)ï¼š
â””â”€ layering              âœ“ (ä»…æ”¯æŒå¿«ç…§)

åˆ›å»ºç¤ºä¾‹ï¼š
$ rbd create --size 10G --image-feature \
  layering,exclusive-lock,object-map,fast-diff \
  pool/image
```

### 11.2 å¯¹è±¡å¤§å°é€‰æ‹©

```
é»˜è®¤ï¼š4 MB (order=22)

å°å¯¹è±¡ (1 MB, order=20)ï¼š
â€¢ ä¼˜ç‚¹ï¼šæ›´ç»†ç²’åº¦çš„æ¡å¸¦åŒ–ï¼Œæ›´å¥½çš„éšæœº I/O
â€¢ ç¼ºç‚¹ï¼šæ›´å¤šå¯¹è±¡ï¼Œæ›´å¤šå…ƒæ•°æ®å¼€é”€
â€¢ é€‚ç”¨ï¼šéšæœº I/O å¯†é›†å‹

å¤§å¯¹è±¡ (16 MB, order=24)ï¼š
â€¢ ä¼˜ç‚¹ï¼šæ›´å°‘å¯¹è±¡ï¼Œæ›´å°‘å…ƒæ•°æ®å¼€é”€
â€¢ ç¼ºç‚¹ï¼šæ¡å¸¦ç²’åº¦ç²—ï¼Œéšæœº I/O å·®
â€¢ é€‚ç”¨ï¼šé¡ºåº I/O å¯†é›†å‹

æ¨èï¼š
â€¢ é€šç”¨åœºæ™¯ï¼š4 MB (é»˜è®¤)
â€¢ SSD/NVMeï¼š2-4 MB
â€¢ HDDï¼š4-8 MB
```

### 11.3 å¿«ç…§ç®¡ç†

```
å¿«ç…§ç­–ç•¥ï¼š
1. å®šæœŸåˆ›å»ºå¿«ç…§ (å¦‚æ¯å¤©)
2. ä¿ç•™æœ‰é™æ•°é‡ (å¦‚ 7 å¤©)
3. åˆ é™¤è¿‡æœŸå¿«ç…§
4. ç›‘æ§å¿«ç…§ç©ºé—´å ç”¨

ç¤ºä¾‹è„šæœ¬ï¼š
#!/bin/bash
IMAGE=pool/myimage
KEEP_DAYS=7

# åˆ›å»ºå¿«ç…§
rbd snap create ${IMAGE}@$(date +%Y%m%d)

# åˆ é™¤æ—§å¿«ç…§
rbd snap ls ${IMAGE} | while read snap; do
  age=$(( ($(date +%s) - $(stat -c %Y ${snap})) / 86400 ))
  if [ $age -gt $KEEP_DAYS ]; then
    rbd snap rm ${IMAGE}@${snap}
  fi
done
```

---

## åäºŒã€æ€»ç»“

RBD æ˜¯ Ceph æä¾›çš„**å—å­˜å‚¨æ¥å£**ï¼Œæ ¸å¿ƒç‰¹ç‚¹ï¼š

âœ… **åˆ†å±‚æ¶æ„**ï¼šAPI â†’ Dispatch Chain â†’ ObjectRequest â†’ librados
âœ… **å¯¹è±¡æ˜ å°„**ï¼šè™šæ‹Ÿå—è®¾å¤‡ â†’ 4MB RADOS å¯¹è±¡
âœ… **å¿«ç…§å…‹éš†**ï¼šCOW + åˆ†å±‚ï¼Œé«˜æ•ˆå…±äº«æ•°æ®
âœ… **ç¼“å­˜ä¼˜åŒ–**ï¼šObject Cacher + PWL
âœ… **é«˜çº§ç‰¹æ€§**ï¼šObject Map, Exclusive Lock, Journaling
âœ… **é•œåƒå¤åˆ¶**ï¼šä¸»å¤‡é›†ç¾¤åŒæ­¥ï¼Œç¾éš¾æ¢å¤
âœ… **æ€§èƒ½è°ƒä¼˜**ï¼šQoS, Readahead, é¢„åˆ†é…

ä»£ç ç»„ç»‡æ¸…æ™°ï¼Œæ¨¡å—åŒ–ç¨‹åº¦é«˜ï¼Œæ˜¯å­¦ä¹ åˆ†å¸ƒå¼å—å­˜å‚¨çš„ä¼˜ç§€èŒƒä¾‹ï¼ğŸš€

